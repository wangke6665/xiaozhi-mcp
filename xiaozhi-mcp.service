#!/bin/bash
# OpenClaw - å°æ™º AI MCP å®¢æˆ·ç«¯æœåŠ¡è„šæœ¬

LOG_FILE="/tmp/xiaozhi-mcp.log"
PID_FILE="/tmp/xiaozhi-mcp.pid"
CLIENT_SCRIPT="/root/.openclaw/workspace/xiaozhi-client.js"

# Searxng æœç´¢å®ä¾‹ï¼ˆå…è´¹ï¼‰
export SEARXNG_URL="https://searx.tiekoetter.com"

case "$1" in
  start)
    if [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null; then
      echo "å°æ™º MCP å®¢æˆ·ç«¯å·²åœ¨è¿è¡Œ (PID: $(cat $PID_FILE))"
      exit 0
    fi
    echo "å¯åŠ¨å°æ™º MCP å®¢æˆ·ç«¯..."
    nohup node "$CLIENT_SCRIPT" >> "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"
    sleep 2
    if kill -0 $(cat "$PID_FILE") 2>/dev/null; then
      echo "âœ… å¯åŠ¨æˆåŠŸ (PID: $(cat $PID_FILE))"
      echo "ğŸ“‹ æ—¥å¿—: tail -f $LOG_FILE"
    else
      echo "âŒ å¯åŠ¨å¤±è´¥"
      rm -f "$PID_FILE"
    fi
    ;;
  
  stop)
    if [ -f "$PID_FILE" ]; then
      PID=$(cat "$PID_FILE")
      if kill -0 "$PID" 2>/dev/null; then
        echo "åœæ­¢å°æ™º MCP å®¢æˆ·ç«¯ (PID: $PID)..."
        kill "$PID"
        rm -f "$PID_FILE"
        echo "âœ… å·²åœæ­¢"
      else
        echo "è¿›ç¨‹ä¸å­˜åœ¨"
        rm -f "$PID_FILE"
      fi
    else
      echo "å°æ™º MCP å®¢æˆ·ç«¯æœªè¿è¡Œ"
    fi
    ;;
  
  status)
    if [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null; then
      echo "ğŸŸ¢ å°æ™º MCP å®¢æˆ·ç«¯è¿è¡Œä¸­ (PID: $(cat $PID_FILE))"
      echo "ğŸ“‹ æœ€è¿‘æ—¥å¿—:"
      tail -10 "$LOG_FILE"
    else
      echo "ğŸ”´ å°æ™º MCP å®¢æˆ·ç«¯æœªè¿è¡Œ"
      rm -f "$PID_FILE"
    fi
    ;;
  
  log)
    tail -f "$LOG_FILE"
    ;;
  
  *)
    echo "ç”¨æ³•: $0 {start|stop|status|log}"
    exit 1
    ;;
esac
